{% extends "base.html" %}
{% load staticfiles%}

{% block title %}{{ mix_nickname }} Drill{% endblock %}
{% block script %}
<script>
        var request = new XMLHttpRequest();

        function draw(data) {
            var list = document.getElementById("list");
            var template = document.getElementById("template");
            var output = [];
            data.forEach(function (item) {
                console.log(item);
                var text = template.innerHTML;
                for (var p in item) {
                    if (item.hasOwnProperty(p)) {
                        text = text.replace("{bird." + p + "}", item[p]);
                    }
                }
                output.push(text)
                });
            list.innerHTML = "<li>" + output.join("</li><li>") + "</li>";
        }

        function validateMix(data) {
            if (data.length < 3) {
                console.log("less than 3");
                return false;
            } else {
                return true;
            }
        }

        function getFrequencies() {
            var frequency_new = document.getElementById("frequency_new").innerHTML;
            var frequency_learned = document.getElementById("frequency_learned").innerHTML;
            var frequency_missed = document.getElementById("frequency_missed").innerHTML;
            // add frequencies together and divide each by the sum to get percentage

        }


        function drawQuestion(data) {
            //   validateMix() // validate mix has at least 3 birds
            if (validateMix(data)) {
                console.log("mix validates");
            } else {
                console.log("mix fails validation")
            }
            var frequencyArray = getFrequencies(); // how do I return 3 values?
            //   getFrequencies() // get settings from Drill model
            //   sortBirdList() // get list of user birds from mix and separate into new/learned/missed lists (delete "excluded)
            // *** repeat functions below after feedback is given **** //
            //   chooseBirdPile() // use random number to decide which bird pile to pull from (new/learned/missed)
            //   selectBird() // get random bird from bird_list where bird_pile = ___
            //   selectDistractors() // get 2 random birds from bird list that aren't the selected Bird
            //   randomizeOptions() // combine selected bird and distractors into one list, then scramble order
            //   compilateAudio() // concatenate the audio for the birds in the question, same order multiple choice
            //   playBird() // audio should auto play when page loads
            //   ONCLICK check(Answer) check answer, give feedback, and move bird into new bird_pile and update JSON object.
            //   TIMEOUT drawMultipleChoice() repeat Choose BirdPile(), etc
        }

        function onRequestChange() {
            console.log(request.readyState, request.status);
            if ((request.readyState == 4) && (request.status == 200)) {
                var data = JSON.parse(request.responseText);
                draw(data);
                drawQuestion(data);
            }
        }

        function fetch(mix_slug) {
            var mix_slug = document.getElementById("mix_slug").innerHTML;
            request.onload = undefined;
            request.onreadystatechange = onRequestChange;
            var slug = "/mix_drill_birds/" + mix_slug + "/";
            console.log(slug);
            request.open("GET", slug, true);
            request.send();
        }
        function load() {
            fetch();
        }
        window.addEventListener("load", load);

        function saveData(formData){
            request.open("POST","/ajax/",true);
            request.onload = fetch;
            request.setRequestHeader("Content-type","application/x-www-form-urlencoded");
            request.send(formData);
        }
        function captureSubmit(){
            //Get inputs inside form and iterate over them.
            var elementList = document.getElementById("f1").children;
            formDataList = [];
            //Creating something like this:
            //title=spiderman&role=hero&color=red
            for(var i=0; i < elementList.length; i++){
                var element = elementList[i];
                formDataList.push(
                        encodeURIComponent(element.name)
                        + "=" +
                        encodeURIComponent(element.value)
                );
                console.log(element.name);
            }
            saveData(formDataList.join("&"));
            //CANCEL FORM SUBMISSION; must be returned in onsubmit below.
            return false;
        }

    </script>
    <style>
        .template {
            display: none;
        }
    </style>{% endblock %}
{% block body %}<body class="{{ mix_color }}">{% endblock %}

{% block maincontent %}
<form  id="f1" action="/ajax/" method="post" onsubmit="return captureSubmit()" >
    <input name="name">
    <input type="submit" value="submit">
</form>
<ul id="list">
</ul>
<ul class="template">
    <li id="template" class="template">
        <span>
           Name: {bird.name}<br>
           BirdPile: {bird.bird_pile}
        </span>
        <br>
        <br>
    </li>
</ul>

<!--end domstuff-->
    <div id="js-variable">
      <div id="mix_slug">{{ mix_slug }}</div>
      <div id="frequency_new">{{ frequency_new }}</div>
      <div id="frequency_learned">{{ frequency_learned }}</div>
      <div id="frequency_missed">{{ frequency_missed }}</div>
    </div>
      <h1><a class="btn btn-default" href="/mix_detail/{{ mix_slug }}" role="button"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> {{ mix_nickname }}</a> Drill</h1>

    <div id="drill">
    <strong>Which bird is this?</strong>
    <audio controls>
        <source src="/static/media/call_common_loon.mp3" type="audio/mpeg" />
    </audio>
    <form role="form" method="post" class="drill-btns">
    {% csrf_token %}
        <button class="btn btn-default btn-lg btn-block" role="button" id="option1">Western Grebe</button>
        <button class="btn btn-default btn-lg btn-block" role="button" id="option2">Common Loon</button>
        <button class="btn btn-default btn-lg btn-block" role="button" id="option3">Great Blue Heron</button>
    <div>
        <p id="test"></p>
    Hint: Listen to all three
    <audio controls>
        <source src="/static/media/call_common_loon.mp3" type="audio/mpeg" />
    </audio>
    </div>
        <hr>
    <div class="checkbox checkbox-lg">
        <label><input type="checkbox" name="listen_only"> Listen-only mode</label> <a href="#" title="Listen-only mode will disable the answer options and autoplay the bird sounds. BirdingEar can't track your learned birds in this mode, so drill settings that involve tracking won't be applied."><span class="glyphicon glyphicon-info-sign"></span></a>
    </div>
    </form>
    <a href="/mix_detail/{{ mix_slug }}" class="btn btn-default colored-btn"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> Back to the {{ mix_nickname }} bird mix</a>

    </div><!--drill-->
{% endblock maincontent %}